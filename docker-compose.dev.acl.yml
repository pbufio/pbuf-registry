services:
  db:
    image: postgres:18.1-alpine3.23
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: pbuf
      POSTGRES_PASSWORD: pbuf
      POSTGRES_DB: pbuf_registry
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-d", "pbuf_registry" ]
      interval: 5s
      timeout: 10s
      retries: 5

  pbuf-registry:
    build:
      context: .
    restart: always
    depends_on:
      - db
    ports:
      - "8080:8080"
      - "6777:6777"
      - "8082:8082"
    healthcheck:
      test: wget -O - http://localhost:8082/healthz || exit 1
      interval: 5s
      timeout: 10s
      retries: 5
    environment:
      DATA_DATABASE_DSN: "postgres://pbuf:pbuf@db:5432/pbuf_registry?sslmode=disable"

      # gRPC TLS (disabled for dev)
      SERVER_GRPC_TLS_ENABLED: "false"

      # Enable ACL auth + request-level authorization
      SERVER_GRPC_AUTH_ENABLED: "true"
      SERVER_GRPC_AUTH_TYPE: acl
      SERVER_HTTP_AUTH_ENABLED: "true"
      SERVER_HTTP_AUTH_TYPE: acl

      # Admin bypass token (also used by the UI and for user/bot management)
      SERVER_STATIC_TOKEN: ${SERVER_STATIC_TOKEN:-dev-admin-token}
    command: >
      sh -c "/app/pbuf-migrations && /app/pbuf-registry"

  pbuf-registry-compaction:
    build:
      context: .
    restart: always
    depends_on:
      - db
      - pbuf-registry
    healthcheck:
      test: wget -O - http://localhost:8082/healthz || exit 1
      interval: 5s
      timeout: 10s
      retries: 5
    environment:
      DATA_DATABASE_DSN: "postgres://pbuf:pbuf@db:5432/pbuf_registry?sslmode=disable"
    command: >
      sh -c "/app/pbuf-registry compaction"

  pbuf-registry-protoparsing:
    build:
      context: .
    restart: always
    depends_on:
      - db
      - pbuf-registry
    healthcheck:
      test: wget -O - http://localhost:8082/healthz || exit 1
      interval: 5s
      timeout: 10s
      retries: 5
    environment:
      DATA_DATABASE_DSN: "postgres://pbuf:pbuf@db:5432/pbuf_registry?sslmode=disable"
    command: >
      sh -c "/app/pbuf-registry proto-parsing"

  pbuf-registry-seed:
    image: python:3.12-slim
    depends_on:
      - db
      - pbuf-registry
    working_dir: /workspace
    volumes:
      - ./scripts:/workspace/scripts:ro
    environment:
      DATABASE_DSN: "postgres://pbuf:pbuf@db:5432/pbuf_registry?sslmode=disable"
      SEED_MODULE_NAME: "yourorg/hello-proto"

      # Stable, developer-friendly tokens (you can override them when running the container)
      SEED_READER_TOKEN: "pbuf_user_dev_reader_token"
      SEED_WRITER_TOKEN: "pbuf_user_dev_writer_token"
      SEED_BOT_TOKEN: "pbuf_bot_dev_ci_token"
    command: >
      sh -c "python -m pip install --no-cache-dir 'psycopg[binary]' && python scripts/seed_acl_dev.py"
